<?php

declare(strict_types=1);

namespace {{apiPackage}}\Security;

use Illuminate\Routing\Router;

/**
 * SecurityValidator
 *
 * Auto-generated security validator from OpenAPI security requirements
 *
 * Validates that all required security middleware are properly configured
 * and implement the required interfaces from OpenAPI security schemes
 *
 * RUNS ONLY IN DEBUG MODE (APP_DEBUG=true)
 *
 * PSR-4 COMPLIANT: One class per file
 */
class SecurityValidator
{
    /**
     * Security scheme to interface mapping
     *
     * Auto-generated from OpenAPI security schemes
     *
     * @var array<string, string>
     */
    private static array $securitySchemes = [
{{#securitySchemes}}
        '{{name}}' => {{interfaceName}}::class,
{{/securitySchemes}}
    ];

    /**
     * Operation to required security schemes mapping
     *
     * Auto-generated from OpenAPI operations security requirements
     *
     * @var array<string, array<string>>
     */
    private static array $operationSecurity = [
{{#operations}}
{{#hasAuthMethods}}
        '{{operationId}}' => [{{#authMethods}}'{{name}}'{{^-last}}, {{/-last}}{{/authMethods}}],
{{/hasAuthMethods}}
{{/operations}}
    ];

    /**
     * Validate middleware configuration
     *
     * Checks that all required security middleware groups are defined
     * and that they contain middleware implementing the required interfaces
     *
     * @param Router $router
     * @return void
     * @throws \RuntimeException if validation fails
     */
    public static function validateMiddleware(Router $router): void
    {
        $errors = [];

        // Get all unique security schemes used across operations
        $requiredSchemes = [];
        foreach (self::$operationSecurity as $operation => $schemes) {
            foreach ($schemes as $scheme) {
                $requiredSchemes[$scheme][] = $operation;
            }
        }

        // Validate each security scheme
        foreach ($requiredSchemes as $scheme => $operations) {
            $middlewareGroup = "api.security.{$scheme}";
            $interfaceClass = self::$securitySchemes[$scheme] ?? null;

            if (!$interfaceClass) {
                $errors[] = "Unknown security scheme '{$scheme}' (no interface defined)";
                continue;
            }

            // Check if middleware group is defined
            if (!$router->hasMiddlewareGroup($middlewareGroup)) {
                $errors[] = sprintf(
                    "Missing middleware group '%s' for security scheme '%s'\n" .
                    "  Required by operations: %s\n" .
                    "  Middleware must implement: %s\n" .
                    "  Define in bootstrap/app.php:\n" .
                    "    \$middleware->group('%s', [\n" .
                    "        \\Your\\Namespace\\YourAuthMiddleware::class,\n" .
                    "    ]);",
                    $middlewareGroup,
                    $scheme,
                    implode(', ', $operations),
                    $interfaceClass,
                    $middlewareGroup
                );
                continue;
            }

            // Validate that middleware implements required interface
            $middlewareStack = $router->getMiddlewareGroups()[$middlewareGroup] ?? [];

            if (empty($middlewareStack)) {
                $errors[] = sprintf(
                    "Middleware group '%s' is defined but EMPTY\n" .
                    "  Add middleware implementing: %s",
                    $middlewareGroup,
                    $interfaceClass
                );
                continue;
            }

            // Check if at least one middleware implements the interface
            $hasValidMiddleware = false;
            foreach ($middlewareStack as $middleware) {
                // Handle middleware class strings
                $middlewareClass = is_string($middleware) ? $middleware : get_class($middleware);

                if (class_exists($middlewareClass)) {
                    $implements = class_implements($middlewareClass);
                    if ($implements && in_array($interfaceClass, $implements)) {
                        $hasValidMiddleware = true;
                        break;
                    }
                }
            }

            if (!$hasValidMiddleware) {
                $middlewareList = array_map(function ($m) {
                    return '    - ' . (is_string($m) ? $m : get_class($m));
                }, $middlewareStack);

                $errors[] = sprintf(
                    "Middleware group '%s' does NOT contain middleware implementing %s\n" .
                    "  Current middleware in group:\n%s\n" .
                    "  At least one middleware must implement the interface",
                    $middlewareGroup,
                    $interfaceClass,
                    implode("\n", $middlewareList)
                );
            }
        }

        // Throw exception if any errors found
        if (!empty($errors)) {
            throw new \RuntimeException(
                "\n" .
                "================================================================================\n" .
                "SECURITY MIDDLEWARE VALIDATION FAILED\n" .
                "================================================================================\n\n" .
                implode("\n\n", $errors) . "\n\n" .
                "================================================================================\n" .
                "Fix these issues in bootstrap/app.php or disable validation in production\n" .
                "by setting APP_DEBUG=false\n" .
                "================================================================================\n"
            );
        }
    }

    /**
     * Get required security schemes for an operation
     *
     * @param string $operationId
     * @return array<string>
     */
    public static function getOperationSecurity(string $operationId): array
    {
        return self::$operationSecurity[$operationId] ?? [];
    }

    /**
     * Get all security scheme interfaces
     *
     * @return array<string, string>
     */
    public static function getSecuritySchemes(): array
    {
        return self::$securitySchemes;
    }
}
