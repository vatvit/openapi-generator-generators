# OpenAPI Generator version (pinned for reproducibility)
OPENAPI_GENERATOR_VERSION := latest

.PHONY: help generate extract-templates extract-laravel-templates check-version update-generator-version

help: ## Show OpenAPI Generator utility commands
	@echo "OpenAPI Generator - Utility Commands"
	@echo "===================================="
	@echo "Available commands:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-25s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "Usage example:"
	@echo "  make generate SPEC_NAME=petshop SPEC_FILE=petshop-extended.yaml \\"
	@echo "                OUTPUT_NAME=petstore CONFIG=petshop-server-config.json \\"
	@echo "                TEMPLATE_PATH=openapi-generator-server-templates/openapi-generator-server-php-laravel"

generate: ## Generate server code (requires: SPEC_NAME, SPEC_FILE, OUTPUT_NAME, CONFIG, TEMPLATE_PATH, optional: PREPROCESS=yes)
ifndef SPEC_NAME
	$(error SPEC_NAME is required. Example: SPEC_NAME=petshop)
endif
ifndef SPEC_FILE
	$(error SPEC_FILE is required. Example: SPEC_FILE=petshop-extended.yaml)
endif
ifndef OUTPUT_NAME
	$(error OUTPUT_NAME is required. Example: OUTPUT_NAME=petstore)
endif
ifndef CONFIG
	$(error CONFIG is required. Example: CONFIG=petshop-server-config.json)
endif
ifndef TEMPLATE_PATH
	$(error TEMPLATE_PATH is required. Example: TEMPLATE_PATH=openapi-generator-server-templates/openapi-generator-server-php-laravel)
endif
	@echo "üèóÔ∏è  Generating $(SPEC_NAME) API server with custom templates (PSR-4 compliant)..."
	@rm -rf ../../generated/php-laravel/$(OUTPUT_NAME)
	@mkdir -p ../../generated/php-laravel
ifeq ($(PREPROCESS),yes)
	@echo "üîß Preprocessing: Setting operation-specific tags..."
	@SPEC_EXT=$${SPEC_FILE##*.}; \
	PROCESSED_FILE="../../openapi-generator-specs/$(SPEC_NAME)/$(SPEC_NAME)-tagged.$$SPEC_EXT"; \
	./scripts/set-operation-tags.sh "../../openapi-generator-specs/$(SPEC_NAME)/$(SPEC_FILE)" "$$PROCESSED_FILE"; \
	echo "üìã Generating from preprocessed spec: openapi-generator-specs/$(SPEC_NAME)/$(SPEC_NAME)-tagged.$$SPEC_EXT"; \
	docker run --rm -v $$(pwd)/../..:/local openapitools/openapi-generator-cli:$(OPENAPI_GENERATOR_VERSION) generate \
		-i /local/openapi-generator-specs/$(SPEC_NAME)/$(SPEC_NAME)-tagged.$${SPEC_EXT} \
		-g php-laravel \
		-o /local/generated/php-laravel/$(OUTPUT_NAME) \
		-c /local/projects/laravel-api--php-laravel--replaced-tags/openapi-generator-configs/$(CONFIG) \
		-t /local/$(TEMPLATE_PATH)
else
	@echo "üìã Generating from spec: openapi-generator-specs/$(SPEC_NAME)/$(SPEC_FILE)"
	@docker run --rm -v $$(pwd)/../..:/local openapitools/openapi-generator-cli:$(OPENAPI_GENERATOR_VERSION) generate \
		-i /local/openapi-generator-specs/$(SPEC_NAME)/$(SPEC_FILE) \
		-g php-laravel \
		-o /local/generated/php-laravel/$(OUTPUT_NAME) \
		-c /local/projects/laravel-api--php-laravel--replaced-tags/openapi-generator-configs/$(CONFIG) \
		-t /local/$(TEMPLATE_PATH)
endif
	@echo "‚úÖ $(SPEC_NAME) API server generated (PSR-4: one class per file)!"
	@echo "üìÅ Output: generated/php-laravel/$(OUTPUT_NAME)"

extract-templates: ## Extract default PHP client templates for customization
	@echo "üì¶ Extracting default PHP templates..."
	@mkdir -p ../../openapi-generator-default-php-laravel/php-default
	@docker run --rm -v $$(pwd)/../..:/local openapitools/openapi-generator-cli:$(OPENAPI_GENERATOR_VERSION) author template \
		-g php -o /local/openapi-generator-default-php-laravel/php-default
	@echo "‚úÖ PHP templates extracted to: openapi-generator-default-php-laravel/php-default/"
	@echo "‚ÑπÔ∏è  You can copy and modify templates from there for reference"

extract-laravel-templates: ## Extract default php-laravel templates for customization
	@echo "üì¶ Extracting php-laravel templates..."
	@mkdir -p ../../openapi-generator-default-php-laravel/php-laravel-default
	@docker run --rm -v $$(pwd)/../..:/local openapitools/openapi-generator-cli:$(OPENAPI_GENERATOR_VERSION) author template \
		-g php-laravel -o /local/openapi-generator-default-php-laravel/php-laravel-default
	@echo "‚úÖ Laravel templates extracted to: openapi-generator-default-php-laravel/php-laravel-default/"

check-version: ## Check generated code version matches expected (accepts same major.minor, any patch)
	@echo "üîç Checking OpenAPI Generator version..."
	@if [ "$(OPENAPI_GENERATOR_VERSION)" = "latest" ]; then \
		echo "‚ÑπÔ∏è  Using 'latest' version - skipping strict version check"; \
		for version_file in ../../generated/php-laravel/*/.openapi-generator/VERSION; do \
			if [ -f "$$version_file" ]; then \
				api_name=$$(basename $$(dirname $$(dirname $$version_file))); \
				actual_version=$$(cat $$version_file | tr -d '\n'); \
				printf "  üìã %-12s: %s\n" "$$api_name" "$$actual_version"; \
			fi; \
		done; \
		echo "‚úÖ Version check passed (using latest)"; \
	else \
		expected_version=$$(echo $(OPENAPI_GENERATOR_VERSION) | sed 's/^v//'); \
		expected_major_minor=$$(echo $$expected_version | cut -d. -f1,2); \
		all_valid=true; \
		for version_file in ../../generated/php-laravel/*/.openapi-generator/VERSION; do \
			if [ -f "$$version_file" ]; then \
				api_name=$$(basename $$(dirname $$(dirname $$version_file))); \
				actual_version=$$(cat $$version_file | tr -d '\n' | sed 's/-SNAPSHOT//'); \
				actual_major_minor=$$(echo $$actual_version | cut -d. -f1,2); \
				printf "  üìã %-12s: %s" "$$api_name" "$$actual_version"; \
				if [ "$$actual_major_minor" != "$$expected_major_minor" ]; then \
					echo " ‚ùå (expected $$expected_major_minor.x)"; \
					all_valid=false; \
				else \
					echo " ‚úÖ"; \
				fi; \
			fi; \
		done; \
		if [ "$$all_valid" = "false" ]; then \
			echo ""; \
			echo "‚ùå Version mismatch detected!"; \
			echo "   Expected: $$expected_major_minor.x"; \
			echo "   Run: make update-generator-version VERSION=vX.Y.Z"; \
			exit 1; \
		fi; \
		echo "‚úÖ All generated APIs use compatible OpenAPI Generator version ($$expected_major_minor.x)"; \
	fi

update-generator-version: ## Update OpenAPI Generator version (Usage: make update-generator-version VERSION=v7.19.0)
ifndef VERSION
	$(error VERSION required. Usage: make update-generator-version VERSION=v7.19.0)
endif
	@echo "üì• Updating OpenAPI Generator to $(VERSION)..."
	@sed -i '' 's/OPENAPI_GENERATOR_VERSION := .*/OPENAPI_GENERATOR_VERSION := $(VERSION)/' Makefile
	@echo "üê≥ Pulling Docker image: openapitools/openapi-generator-cli:$(VERSION)"
	@docker pull openapitools/openapi-generator-cli:$(VERSION)
	@echo "‚úÖ Updated to $(VERSION)"
	@echo "‚ÑπÔ∏è  Run 'make generate-server' to regenerate code with new version"
